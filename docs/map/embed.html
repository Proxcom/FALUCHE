<!DOCTYPE html>
<html>

<head>
	<base target="_top">
	<meta charset="UTF-8" />
	<meta name="description" content=" Simulation de FALUCHERIE et lexique des particularités">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Prox Acom">
	<title>FALUCHERIE</title>
	<link rel="icon" type="image/x-icon" href="/assets/images/faluche-stadium.sticker.boxed.png">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
	 crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
	 crossorigin=""></script>
	<!-- Load jQuery and PapaParse to read data from a CSV file -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
</head>

<style>
	html,
	body {
		height: 100%;
		margin: 0;
	}

	.leaflet-container {
		height: 100%;
		width: 100%;
		max-width: 100%;
		max-height: 100%;
	}
</style>
</head>

<body>
	<div id="map"></div>
	<script>

		let markerfal = L.icon({
			iconUrl: '/assets/images/faluche-stadium.sticker.boxed.png',
			iconSize:     [32, 32], // size of the icon
			iconAnchor:   [16, 16], // point of the icon which will correspond to marker's location
			popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
		});

		let CartoDB = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
			subdomains: 'abcd',
			maxZoom: 20
		});

		let osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 20,
			attribution: '© OpenStreetMap'
		});

		let map = L.map('map', {
			center: [46.5, 2.75],
			zoom: 6,
			layers: [osm],
		});

		map.createPane('labels');
		map.getPane('labels').style.zIndex = 650;
		map.getPane('labels').style.pointerEvents = 'none';

		let baseMaps = {
			"OpenStreetMap": osm,
			"CartoDB": CartoDB,
		};

		let overlays = {};

		//Faire carte des caricatures

		let layerControl = L.control.layers(baseMaps, overlays).addTo(map);

		function featureName(properties, fallback) {
			if (!properties) {
				return fallback;
			}
			return properties.nom || properties.name || properties.Nom || properties.nom_dep || fallback;
		}

		fetch('geojson/departements.geojson')
			.then(function (response) {
				if (!response.ok) {
					throw new Error('Impossible de charger les départements (' + response.status + ')');
				}
				return response.json();
			})
			.then(function (departementsData) {
				let departementsLayer = L.geoJSON(departementsData, {
					onEachFeature: function (feature, layer) {
						layer.bindTooltip(featureName(feature.properties, 'Département inconnu'), { sticky: true });
					}
				});
				overlays['Départements'] = departementsLayer;
				layerControl.addOverlay(departementsLayer, 'Départements');
			})
			.catch(function (error) {
				console.error(error);
			});

		fetch('geojson/regions.geojson')
			.then(function (response) {
				if (!response.ok) {
					throw new Error('Impossible de charger les régions (' + response.status + ')');
				}
				return response.json();
			})
			.then(function (regionsData) {
				let regionsLayer = L.geoJSON(regionsData, {
					onEachFeature: function (feature, layer) {
						layer.bindTooltip(featureName(feature.properties, 'Région inconnue'), { sticky: true });
					}
				});
				overlays['Régions'] = regionsLayer;
				layerControl.addOverlay(regionsLayer, 'Régions');
			})
			.catch(function (error) {
				console.error(error);
			});

		$.get('/assets/data/carte.csv', function (csvString) {

			let data = Papa.parse(csvString, { header: true, dynamicTyping: true }).data;

			for (let i in data) {
				let row = data[i];

				let marker = L.marker([row.Latitude, row.Longitude], {
					opacity: 1,
					icon: markerfal
				}).bindPopup("<strong>" + row.Nom_Ville + "</strong></br>Association Falucharde: " + row.Asso + " (" + row.Asso_Desc + ")" + "</br>Nom du Congrès: " + row.Congres);

				marker.addTo(map);
			}

		});

		L.control.scale({
			position: 'bottomright',
			imperial: false
		}).addTo(this.map);

		map.attributionControl.setPrefix(
			'<a href="https://github.com/Proxcom/FALUCHERIE" target="_blank">Code source</a>'
		);

	</script>
</body>

</html>